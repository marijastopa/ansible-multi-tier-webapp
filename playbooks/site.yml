---
# Main playbook - Deploy complete multi-tier web infrastructure
# This playbook orchestrates the deployment of all components

- name: Deploy multi-tier web application infrastructure
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg: |
          Deploying Multi-Tier Web Infrastructure
          Environment: {{ env_name | default('development') }}
          Total hosts: {{ ansible_play_hosts | length }}
          Load balancers: {{ groups['loadbalancers'] | length }}
          Web servers: {{ groups['webservers'] | length }}
      run_once: true
      tags:
        - always

# Apply common configuration to all servers
- name: Configure common settings on all hosts
  hosts: all
  become: true
  gather_facts: true
  
  roles:
    - role: common
      tags:
        - common

# Deploy web servers
- name: Deploy and configure web servers
  hosts: webservers
  become: true
  gather_facts: true
  
  roles:
    - role: webserver
      tags:
        - webserver

# Deploy load balancers
- name: Deploy and configure load balancers
  hosts: loadbalancers
  become: true
  gather_facts: true
  
  roles:
    - role: loadbalancer
      tags:
        - loadbalancer

# Final status check
- name: Deployment summary
  hosts: all
  become: false
  gather_facts: false

  tasks:
    - name: Display deployment completion
      ansible.builtin.debug:
        msg: |
          Deployment Complete!
          Environment: {{ env_name | default('development') }}
          
          Load Balancers:
          {% for host in groups['loadbalancers'] %}
            - {{ host }}: http://localhost:8080
          {% endfor %}
          
          Web Servers:
          {% for host in groups['webservers'] %}
            - {{ host }}: http://localhost
          {% endfor %}
          
          HAProxy Stats:
            - http://localhost:8081/haproxy?stats
      run_once: true
      tags:
        - always