# HAProxy configuration
# {{ ansible_managed }}

# Global settings
global
    log {{ haproxy_global_log }}
    chroot {{ haproxy_global_chroot }}
    stats socket {{ haproxy_global_stats_socket }}
    stats timeout 30s
    user {{ haproxy_user }}
    group {{ haproxy_group }}
{% if haproxy_global_daemon %}
    daemon
{% endif %}

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    # Default ciphers to use on SSL-enabled listening sockets
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

    maxconn {{ haproxy_global_maxconn }}

# Common defaults
defaults
    mode {{ haproxy_defaults_mode }}
    log {{ haproxy_defaults_log }}
{% for option in haproxy_defaults_option %}
    option {{ option }}
{% endfor %}
    timeout connect {{ haproxy_defaults_timeout_connect }}
    timeout client {{ haproxy_defaults_timeout_client }}
    timeout server {{ haproxy_defaults_timeout_server }}
    retries {{ haproxy_defaults_retries }}
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Frontend configuration
frontend {{ haproxy_frontend_name }}
    bind {{ haproxy_frontend_bind_address }}:{{ haproxy_frontend_bind_port }}
{% if haproxy_ssl_enabled %}
    bind {{ haproxy_frontend_bind_address }}:{{ haproxy_frontend_ssl_port }} ssl crt {{ haproxy_ssl_certificate_path }}
{% endif %}
    mode {{ haproxy_frontend_mode }}
    default_backend {{ haproxy_frontend_default_backend }}

{% if haproxy_stats_enabled %}

# Stats page configuration
listen stats
    bind {{ haproxy_frontend_bind_address }}:{{ haproxy_stats_port }}
    mode http
    stats enable
    stats uri {{ haproxy_stats_uri }}
    stats realm {{ haproxy_stats_realm }}
{% if haproxy_stats_auth_enabled %}
    stats auth {{ haproxy_stats_username }}:{{ haproxy_stats_password }}
{% endif %}
    stats refresh {{ haproxy_stats_refresh }}
    stats show-node
    stats show-legends
    stats show-desc Load Balancer for {{ app_name | default('webapp') }}
{% endif %}

# Backend configuration - Dynamic web servers from inventory
backend {{ haproxy_backend_name }}
    mode {{ haproxy_backend_mode }}
    balance {{ haproxy_backend_balance }}
{% if haproxy_backend_cookie %}
    cookie {{ haproxy_backend_cookie }}
{% endif %}
{% if haproxy_health_check_enabled %}
    option httpchk {{ haproxy_health_check_method }} {{ haproxy_health_check_uri }}
{% endif %}

    # Web servers from inventory
{% for host in groups['webservers'] | default([]) %}
    server {{ host }} {{ hostvars[host]['ansible_host'] | default(host) }}:{{ http_port | default(80) }} check inter {{ haproxy_health_check_interval }} rise {{ haproxy_health_check_rise }} fall {{ haproxy_health_check_fall }} cookie {{ host }}
{% endfor %}